@page "/AlertasPage"
@using FrontEndBlazor.Models
@using FrontEndBlazor.Services
@inject IAlertaService AlertaService
@inject IAuthService AuthService
@inject NavigationManager NavigationManager

<PageTitle>Alertas y Notificaciones</PageTitle>

<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="title-style">üîî Sistema de Alertas</h2>
            <p class="text-muted">Monitoreo de stock y vencimientos en tiempo real</p>
        </div>
        <div>
            <button class="btn btn-outline-secondary" @onclick="LoadAlertas">
                üîÑ Recargar
            </button>
        </div>
    </div>

    <!-- Estad√≠sticas -->
    @if (stats != null)
    {
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center border-danger">
                    <div class="card-body">
                        <h3 class="text-danger">@stats.TotalActivas</h3>
                        <p class="mb-0 text-muted">Alertas Activas</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-warning">
                    <div class="card-body">
                        <h3 class="text-warning">@GetPrioridadCount("CRITICA")</h3>
                        <p class="mb-0 text-muted">Cr√≠ticas</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-success">
                    <div class="card-body">
                        <h3 class="text-success">@stats.ResueltasHoy</h3>
                        <p class="mb-0 text-muted">Resueltas Hoy</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-info">
                    <div class="card-body">
                        <h3 class="text-info">@stats.CreadasHoy</h3>
                        <p class="mb-0 text-muted">Creadas Hoy</p>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Estado</label>
                    <select class="form-select" @bind="filtroEstado">
                        <option value="">Todos</option>
                        <option value="ACTIVA">Activas</option>
                        <option value="PENDIENTE_REPOSICION">Pendiente Reposici√≥n</option>
                        <option value="RESUELTA">Resueltas</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Tipo</label>
                    <select class="form-select" @bind="filtroTipo">
                        <option value="">Todos</option>
                        <option value="STOCK_AGOTADO">Stock Agotado</option>
                        <option value="STOCK_CRITICO">Stock Cr√≠tico</option>
                        <option value="STOCK_MINIMO">Stock M√≠nimo</option>
                        <option value="VENCIDO">Vencido</option>
                        <option value="VENCIMIENTO_INMEDIATO">Vence Pronto</option>
                        <option value="VENCIMIENTO_PROXIMO">Pr√≥ximo a Vencer</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Prioridad</label>
                    <select class="form-select" @bind="filtroPrioridad">
                        <option value="">Todas</option>
                        <option value="CRITICA">Cr√≠tica</option>
                        <option value="ALTA">Alta</option>
                        <option value="MEDIA">Media</option>
                        <option value="BAJA">Baja</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-primary w-100" @onclick="AplicarFiltros">
                        üîç Buscar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alertas -->
    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show">
            ‚úÖ @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = string.Empty"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show">
            ‚ùå @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
        </div>
    }

    @if (loading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary"></div>
            <p class="mt-3">Cargando alertas...</p>
        </div>
    }
    else if (alertas == null || !alertas.Any())
    {
        <div class="alert alert-info">
            ‚ÑπÔ∏è No hay alertas para mostrar.
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Medicamento</th>
                                <th>Tipo</th>
                                <th>Prioridad</th>
                                <th>Estado</th>
                                <th>Mensaje</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var alerta in alertas)
                            {
                                <tr class="@GetRowClass(alerta)">
                                    <td style="font-size: 1.5rem;">@alerta.TipoIcon</td>
                                    <td>
                                        <div class="fw-bold">@alerta.MedicamentoNombre</div>
                                        <div class="small text-muted">
                                            @alerta.MedicamentoFabricante - @alerta.MedicamentoPresentacion
                                        </div>
                                        @if (!string.IsNullOrEmpty(alerta.MedicamentoLote))
                                        {
                                            <div class="small text-muted">Lote: @alerta.MedicamentoLote</div>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">@alerta.TipoLabel</span>
                                    </td>
                                    <td>
                                        <span class="@alerta.PrioridadBadgeClass">@alerta.Prioridad</span>
                                    </td>
                                    <td>
                                        <span class="@alerta.EstadoBadgeClass">@alerta.Estado</span>
                                    </td>
                                    <td>
                                        @alerta.Mensaje
                                        @if (alerta.StockActual.HasValue)
                                        {
                                            <div class="small text-muted">
                                                Stock: @alerta.StockActual / M√≠nimo: @alerta.StockMinimo
                                            </div>
                                        }
                                        @if (alerta.DiasRestantes.HasValue)
                                        {
                                            <div class="small text-muted">
                                                @if (alerta.DiasRestantes.Value < 0)
                                                {
                                                    <span class="text-danger">Vencido hace @Math.Abs(alerta.DiasRestantes.Value) d√≠as</span>
                                                }
                                                else
                                                {
                                                    <span>Vence en @alerta.DiasRestantes d√≠as</span>
                                                }
                                            </div>
                                        }
                                    </td>
                                    <td>
                                        <small class="text-muted">@alerta.TiempoTranscurrido</small>
                                    </td>
                                    <td>
                                        @if (alerta.Estado == EstadoAlerta.ACTIVA)
                                        {
                                            <button class="btn btn-sm btn-success" @onclick="() => MarcarComoResuelta(alerta.Id)">
                                                ‚úì Resolver
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<AlertaDto> alertas = new();
    private AlertaStatsDto? stats;
    private bool loading = true;
    private string successMessage = string.Empty;
    private string errorMessage = string.Empty;

    // Filtros
    private string filtroEstado = "";
    private string filtroTipo = "";
    private string filtroPrioridad = "";

    private bool firstRender = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadAlertas();
        await LoadStats();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && this.firstRender)
        {
            this.firstRender = false;
            await LoadAlertas();
            await LoadStats();
            StateHasChanged();
        }
    }

    private async Task LoadAlertas()
    {
        loading = true;
        errorMessage = string.Empty;
        try
        {
            // Parsear filtros
            EstadoAlerta? estado = null;
            TipoAlerta? tipo = null;
            PrioridadAlerta? prioridad = null;
            
            // Estado: vac√≠o = todos, valor = filtrar por ese estado
            if (!string.IsNullOrEmpty(filtroEstado))
            {
                if (Enum.TryParse<EstadoAlerta>(filtroEstado, out var e))
                    estado = e;
            }
            
            // Tipo
            if (!string.IsNullOrEmpty(filtroTipo))
            {
                if (Enum.TryParse<TipoAlerta>(filtroTipo, out var t))
                    tipo = t;
            }
            
            // Prioridad
            if (!string.IsNullOrEmpty(filtroPrioridad))
            {
                if (Enum.TryParse<PrioridadAlerta>(filtroPrioridad, out var p))
                    prioridad = p;
            }
            
            // Si tiene filtros, usar historial (que permite filtrar por estado)
            // Si no tiene filtros de estado pero tiene otros, usar activas con esos filtros
            if (estado.HasValue || string.IsNullOrEmpty(filtroEstado))
            {
                // Usar historial para obtener todas o filtradas por estado
                alertas = await AlertaService.GetHistorialAlertasAsync(estado: estado);
                
                // Aplicar filtros locales de tipo y prioridad
                if (tipo.HasValue)
                    alertas = alertas.Where(a => a.Tipo == tipo.Value).ToList();
                    
                if (prioridad.HasValue)
                    alertas = alertas.Where(a => a.Prioridad == prioridad.Value).ToList();
            }
            else
            {
                // Sin filtro de estado, usar endpoint de activas
                alertas = await AlertaService.GetAlertasActivasAsync(tipo, prioridad);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cargar alertas: {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

    private async Task LoadStats()
    {
        try
        {
            stats = await AlertaService.GetEstadisticasAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando estad√≠sticas: {ex.Message}");
        }
    }

    private async Task AplicarFiltros()
    {
        await LoadAlertas();
    }

    private async Task MarcarComoResuelta(string alertaId)
    {
        try
        {
            var dto = new AlertaUpdateEstadoDto
            {
                Estado = EstadoAlerta.RESUELTA,
                Notas = "Resuelta desde el frontend"
            };
            
            await AlertaService.ActualizarEstadoAsync(alertaId, dto);
            successMessage = "Alerta marcada como resuelta";
            
            await LoadAlertas();
            await LoadStats();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al resolver alerta: {ex.Message}";
        }
    }

    private string GetRowClass(AlertaDto alerta)
    {
        if (alerta.Estado == EstadoAlerta.RESUELTA) return "table-success";
        if (alerta.Prioridad == PrioridadAlerta.CRITICA) return "table-danger";
        if (alerta.Prioridad == PrioridadAlerta.ALTA) return "table-warning";
        return "";
    }

    private int GetPrioridadCount(string prioridad)
    {
        if (stats?.PorPrioridad == null) return 0;
        return stats.PorPrioridad.TryGetValue(prioridad, out var count) ? count : 0;
    }
}

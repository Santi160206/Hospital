@page "/VentasPage"
@using FrontEndBlazor.Models
@using FrontEndBlazor.Services
@inject IVentaService VentaService
@inject IMedicamentoService MedicamentoService
@inject IAuthService AuthService
@inject NavigationManager NavigationManager
@inject IJSRuntime JS

<PageTitle>Ventas</PageTitle>

<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="title-style">üí∞ Registro de Ventas</h2>
            <p class="text-muted">Registre ventas y actualice autom√°ticamente el stock</p>
        </div>
        <div>
            <button class="btn btn-primary" @onclick="OpenNuevaVentaModal">
                ‚ûï Nueva Venta
            </button>
            <button class="btn btn-outline-secondary ms-2" @onclick="NavigateToReportes">
                üìä Reportes
            </button>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">Fecha Inicio</label>
                    <input type="date" class="form-control" @bind="filtroFechaInicio" @bind:format="yyyy-MM-dd" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Fecha Fin</label>
                    <input type="date" class="form-control" @bind="filtroFechaFin" @bind:format="yyyy-MM-dd" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Buscar por cliente</label>
                    <input type="text" class="form-control" @bind="filtroCliente" placeholder="Nombre del cliente..." />
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" @onclick="AplicarFiltros" disabled="@loading">
                        üîç Filtrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alertas -->
    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show">
            ‚úÖ @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = string.Empty"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show">
            ‚ùå @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
        </div>
    }

    <!-- Loading -->
    @if (loading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary"></div>
            <p class="mt-3">Cargando ventas...</p>
        </div>
    }
    else if (!ventas.Any())
    {
        <div class="alert alert-info text-center">
            <h5>üì≠ No hay ventas registradas</h5>
            <p>Comience registrando una nueva venta haciendo clic en "Nueva Venta"</p>
        </div>
    }
    else
    {
        <!-- Tabla de Ventas -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Total</th>
                                <th>Items</th>
                                <th>Vendedor</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var venta in ventas)
                            {
                                <tr>
                                    <td>
                                        <small class="text-muted">@venta.Id.Substring(0, 8)...</small>
                                    </td>
                                    <td>@venta.FechaFormateada</td>
                                    <td>@(venta.Cliente ?? "Sin cliente")</td>
                                    <td>
                                        <strong class="text-success">@venta.TotalFormateado</strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">@venta.Detalles.Count items</span>
                                    </td>
                                    <td>@venta.UsuarioNombre</td>
                                    <td>
                                        <button class="btn btn-sm btn-info" @onclick="() => OpenDetalleVentaModal(venta)" title="Ver detalle">
                                            üëÅÔ∏è Detalle
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        Mostrando @ventas.Count venta(s) - 
                        Total: <strong>@ventas.Sum(v => v.Total).ToString("C2")</strong>
                    </small>
                </div>
            </div>
        </div>
    }
</div>

<!-- Modal Nueva Venta -->
@if (showNuevaVentaModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">üí∞ Nueva Venta</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseNuevaVentaModal"></button>
                </div>
                <EditForm Model="ventaModel" OnValidSubmit="HandleVentaSubmit">
                    <DataAnnotationsValidator />
                    <div class="modal-body">
                        <!-- B√∫squeda de Medicamentos -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">üîç Agregar Medicamentos</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-8">
                                        <label class="form-label">Buscar medicamento</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" 
                                                   @bind="busquedaMedicamento" 
                                                   @bind:event="oninput"
                                                   placeholder="Nombre del medicamento..." />
                                            <button class="btn btn-outline-secondary" type="button" @onclick="BuscarMedicamentos">
                                                üîç Buscar
                                            </button>
                                        </div>
                                        @if (medicamentosEncontrados.Any() && mostrarSugerencias)
                                        {
                                            <div class="autocomplete-suggestions mt-2">
                                                @foreach (var med in medicamentosEncontrados)
                                                {
                                                    <div class="suggestion-item" @onclick="() => SeleccionarMedicamento(med)">
                                                        <strong>@med.Nombre</strong> - @med.Presentacion<br />
                                                        <small class="text-muted">
                                                            Stock: @med.Stock | Precio: @med.Precio.ToString("C2")
                                                            @if (med.StockBajo)
                                                            {
                                                                <span class="badge bg-warning ms-2">Stock bajo</span>
                                                            }
                                                        </small>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Cantidad</label>
                                        <input type="number" class="form-control" @bind="cantidadSeleccionada" min="1" value="1" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Detalles de la Venta -->
                        <div class="card mb-4">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">üõí Detalles de la Venta</h6>
                                <span class="badge bg-primary">Total: @CalcularTotalVenta().ToString("C2")</span>
                            </div>
                            <div class="card-body">
                                @if (!ventaModel.Detalles.Any())
                                {
                                    <p class="text-muted text-center py-3">No hay medicamentos agregados a la venta</p>
                                }
                                else
                                {
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Medicamento</th>
                                                    <th>Cantidad</th>
                                                    <th>Precio Unitario</th>
                                                    <th>Subtotal</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var detalle in ventaModel.Detalles)
                                                {
                                                    var medicamento = medicamentosEncontrados.FirstOrDefault(m => m.Id == detalle.MedicamentoId);
                                                    <tr>
                                                        <td>
                                                            @if (medicamento != null)
                                                            {
                                                                <div>
                                                                    <strong>@medicamento.Nombre</strong><br />
                                                                    <small class="text-muted">@medicamento.Presentacion</small>
                                                                    @if (detalle.Cantidad > medicamento.Stock)
                                                                    {
                                                                        <br /><span class="badge bg-danger">Stock insuficiente</span>
                                                                    }
                                                                </div>
                                                            }
                                                            else
                                                            {
                                                                <span class="text-danger">Medicamento no encontrado</span>
                                                            }
                                                        </td>
                                                        <td>
                                                            <input type="number" class="form-control form-control-sm" 
                                                                   @bind="detalle.Cantidad" 
                                                                   @onchange="() => StateHasChanged()"
                                                                   min="1" style="width: 80px;" />
                                                        </td>
                                                        <td>
                                                            <input type="number" class="form-control form-control-sm" 
                                                                   @bind="detalle.PrecioUnitario"
                                                                   @onchange="() => StateHasChanged()"
                                                                   step="0.01" min="0.01" style="width: 120px;" 
                                                                   placeholder="@(medicamento?.Precio.ToString("F2") ?? "0.00")" />
                                                        </td>
                                                        <td>
                                                            <strong>@CalcularSubtotal(detalle).ToString("C2")</strong>
                                                        </td>
                                                        <td>
                                                            <button type="button" class="btn btn-sm btn-danger" 
                                                                    @onclick="() => RemoverDetalle(detalle)">
                                                                üóëÔ∏è
                                                            </button>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Informaci√≥n Adicional -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Cliente (Opcional)</label>
                                <InputText class="form-control" @bind-Value="ventaModel.Cliente" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Notas (Opcional)</label>
                                <InputText class="form-control" @bind-Value="ventaModel.Notas" />
                            </div>
                        </div>

                        <!-- Resumen -->
                        <div class="alert alert-info mt-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Total Items:</strong> @ventaModel.Detalles.Count<br />
                                    <strong>Total Unidades:</strong> @ventaModel.Detalles.Sum(d => d.Cantidad)
                                </div>
                                <div class="col-md-6 text-end">
                                    <h5 class="text-success mb-0">Total: @CalcularTotalVenta().ToString("C2")</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseNuevaVentaModal" disabled="@ventaSubmitting">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary" disabled="@ventaSubmitting || !ventaModel.Detalles.Any()">
                            @if (ventaSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            üí∞ Registrar Venta
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

<!-- Modal Detalle Venta -->
@if (showDetalleVentaModal && ventaSeleccionada != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">üëÅÔ∏è Detalle de Venta</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseDetalleVentaModal"></button>
                </div>
                <div class="modal-body">
                    <!-- Informaci√≥n General -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p><strong>ID Venta:</strong> @ventaSeleccionada.Id</p>
                            <p><strong>Fecha:</strong> @ventaSeleccionada.FechaFormateada</p>
                            <p><strong>Vendedor:</strong> @ventaSeleccionada.UsuarioNombre</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Cliente:</strong> @(ventaSeleccionada.Cliente ?? "No especificado")</p>
                            <p><strong>Notas:</strong> @(ventaSeleccionada.Notas ?? "Sin notas")</p>
                            <h4 class="text-success">@ventaSeleccionada.TotalFormateado</h4>
                        </div>
                    </div>

                    <!-- Detalles -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">üõí Medicamentos Vendidos</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Medicamento</th>
                                            <th>Cantidad</th>
                                            <th>Precio Unitario</th>
                                            <th>Subtotal</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var detalle in ventaSeleccionada.Detalles)
                                        {
                                            <tr>
                                                <td>
                                                    <strong>@detalle.MedicamentoNombre</strong>
                                                </td>
                                                <td>@detalle.Cantidad</td>
                                                <td>@detalle.PrecioUnitarioFormateado</td>
                                                <td>
                                                    <strong>@detalle.SubtotalFormateado</strong>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                    <tfoot>
                                        <tr class="table-success">
                                            <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                            <td><strong>@ventaSeleccionada.TotalFormateado</strong></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDetalleVentaModal">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<VentaDto> ventas = new();
    private bool loading = false;
    private string successMessage = string.Empty;
    private string errorMessage = string.Empty;

    // Filtros
    private DateTime filtroFechaInicio = DateTime.Today.AddDays(-7);
    private DateTime filtroFechaFin = DateTime.Today;
    private string filtroCliente = string.Empty;

    // Modal Nueva Venta
    private bool showNuevaVentaModal = false;
    private bool ventaSubmitting = false;
    private VentaCreateDto ventaModel = new();

    // B√∫squeda de medicamentos
    private string busquedaMedicamento = string.Empty;
    private List<MedicamentoDto> medicamentosEncontrados = new();
    private bool mostrarSugerencias = false;
    private int cantidadSeleccionada = 1;

    // Modal Detalle
    private bool showDetalleVentaModal = false;
    private VentaDto? ventaSeleccionada;

    protected override async Task OnInitializedAsync()
    {
        await CargarVentas();
    }

    private async Task CargarVentas()
    {
        try
        {
            loading = true;
            ventas = await VentaService.ListarVentasAsync(filtroFechaInicio, filtroFechaFin);
        }
        catch (Exception ex)
        {
            await MostrarError($"Error al cargar ventas: {ex.Message}");
        }
        finally
        {
            loading = false;
        }
    }

    private async Task AplicarFiltros()
    {
        await CargarVentas();
    }

    private void OpenNuevaVentaModal()
    {
        ventaModel = new VentaCreateDto();
        showNuevaVentaModal = true;
    }

    private void CloseNuevaVentaModal()
    {
        showNuevaVentaModal = false;
        ventaModel = new VentaCreateDto();
        medicamentosEncontrados.Clear();
        busquedaMedicamento = string.Empty;
    }

    private async Task BuscarMedicamentos()
    {
        if (string.IsNullOrWhiteSpace(busquedaMedicamento))
            return;

        try
        {
            var resultados = await MedicamentoService.SearchAsync(busquedaMedicamento, "nombre", 10);
            medicamentosEncontrados = resultados.Select(r => new MedicamentoDto 
            { 
                Id = r.Id,
                Nombre = r.Nombre,
                Presentacion = r.Presentacion,
                Stock = 0, // Necesitar√≠as obtener el stock completo
                Precio = 0 // Y el precio
            }).ToList();
            
            mostrarSugerencias = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await MostrarError($"Error al buscar medicamentos: {ex.Message}");
        }
    }

    private void SeleccionarMedicamento(MedicamentoDto medicamento)
    {
        var detalle = new DetalleVentaCreateDto
        {
            MedicamentoId = medicamento.Id,
            Cantidad = cantidadSeleccionada,
            PrecioUnitario = medicamento.Precio > 0 ? medicamento.Precio : null
        };

        ventaModel.Detalles.Add(detalle);
        busquedaMedicamento = string.Empty;
        medicamentosEncontrados.Clear();
        mostrarSugerencias = false;
        cantidadSeleccionada = 1;
        StateHasChanged();
    }

    private void RemoverDetalle(DetalleVentaCreateDto detalle)
    {
        ventaModel.Detalles.Remove(detalle);
        StateHasChanged();
    }

    private double CalcularSubtotal(DetalleVentaCreateDto detalle)
    {
        var precio = detalle.PrecioUnitario ?? 0;
        return precio * detalle.Cantidad;
    }

    private double CalcularTotalVenta()
    {
        return ventaModel.Detalles.Sum(CalcularSubtotal);
    }

    private async Task HandleVentaSubmit()
    {
        try
        {
            ventaSubmitting = true;

            // Validar stock antes de enviar
            foreach (var detalle in ventaModel.Detalles)
            {
                var medicamento = await MedicamentoService.GetByIdAsync(detalle.MedicamentoId);
                if (medicamento != null && detalle.Cantidad > medicamento.Stock)
                {
                    await MostrarError($"Stock insuficiente para {medicamento.Nombre}. Stock disponible: {medicamento.Stock}");
                    return;
                }
            }

            var ventaCreada = await VentaService.CrearVentaAsync(ventaModel);
            await MostrarExito($"Venta registrada exitosamente! Total: {ventaCreada.TotalFormateado}");
            
            CloseNuevaVentaModal();
            await CargarVentas();
        }
        catch (InvalidOperationException ex)
        {
            await MostrarError(ex.Message);
        }
        catch (Exception ex)
        {
            await MostrarError($"Error al registrar venta: {ex.Message}");
        }
        finally
        {
            ventaSubmitting = false;
        }
    }

    private void OpenDetalleVentaModal(VentaDto venta)
    {
        ventaSeleccionada = venta;
        showDetalleVentaModal = true;
    }

    private void CloseDetalleVentaModal()
    {
        showDetalleVentaModal = false;
        ventaSeleccionada = null;
    }

    private void NavigateToReportes()
    {
        NavigationManager.NavigateTo("/reportes-ventas");
    }

    private async Task MostrarExito(string mensaje)
    {
        successMessage = mensaje;
        errorMessage = string.Empty;
        await InvokeAsync(StateHasChanged);
    }

    private async Task MostrarError(string mensaje)
    {
        errorMessage = mensaje;
        successMessage = string.Empty;
        await InvokeAsync(StateHasChanged);
    }
}
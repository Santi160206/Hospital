@page "/ReportesPage"
@using FrontEndBlazor.Models
@using FrontEndBlazor.Services
@inject IReporteService ReporteService
@inject IAuthService AuthService
@inject NavigationManager NavigationManager

<PageTitle>Reportes de Compras</PageTitle>

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0">
                    <i class="bi bi-graph-up-arrow me-2"></i>
                    Reportes de Compras
                </h2>
                <span class="badge bg-danger">Solo Administradores</span>
            </div>
            <p class="text-muted mt-2">Comparación de precios y análisis de compras histórico</p>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="bi bi-funnel me-2"></i>
                Filtros de Búsqueda
            </h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label fw-bold">Fecha Inicio</label>
                    <input type="date" class="form-control" @bind="fechaInicio" max="@DateTime.Today.ToString("yyyy-MM-dd")" />
                </div>
                
                <div class="col-md-3">
                    <label class="form-label fw-bold">Fecha Fin</label>
                    <input type="date" class="form-control" @bind="fechaFin" max="@DateTime.Today.ToString("yyyy-MM-dd")" />
                </div>
                
                <div class="col-md-6 d-flex align-items-end gap-2">
                    <button class="btn btn-success" @onclick="GenerarComparacionPrecios" disabled="@cargando">
                        @if (cargando && tipoReporte == "comparacion")
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        else
                        {
                            <i class="bi bi-bar-chart-line me-2"></i>
                        }
                        Comparar Precios
                    </button>
                    
                    <button class="btn btn-info" @onclick="GenerarReporteCompras" disabled="@cargando">
                        @if (cargando && tipoReporte == "compras")
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        else
                        {
                            <i class="bi bi-file-earmark-text me-2"></i>
                        }
                        Reporte de Compras
                    </button>
                    
                    @if (mostrarResultados)
                    {
                        <button class="btn btn-secondary" @onclick="LimpiarResultados">
                            <i class="bi bi-x-circle me-2"></i>
                            Limpiar
                        </button>
                    }
                </div>
            </div>
            
            @if (!string.IsNullOrEmpty(mensajeValidacion))
            {
                <div class="alert alert-warning mt-3 mb-0" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    @mensajeValidacion
                </div>
            }
        </div>
    </div>

    <!-- Alertas de error -->
    @if (!string.IsNullOrEmpty(mensajeError))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-circle me-2"></i>
            <strong>Error:</strong> @mensajeError
            <button type="button" class="btn-close" @onclick="() => mensajeError = string.Empty"></button>
        </div>
    }

    <!-- Resultados: Comparación de Precios -->
    @if (mostrarResultados && tipoReporte == "comparacion" && comparacionResult != null)
    {
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="bi bi-clipboard-data me-2"></i>
                    Comparación de Precios entre Proveedores
                </h5>
            </div>
            <div class="card-body">
                <!-- Resumen -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="alert alert-info mb-0">
                            <strong>Período:</strong><br/>
                            @comparacionResult.FechaInicio.ToString("dd/MM/yyyy") - @comparacionResult.FechaFin.ToString("dd/MM/yyyy")
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="alert alert-primary mb-0">
                            <strong>Medicamentos:</strong><br/>
                            @comparacionResult.TotalMedicamentos
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="alert alert-warning mb-0">
                            <strong>Proveedores:</strong><br/>
                            @comparacionResult.TotalProveedores
                        </div>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(comparacionResult.Mensaje))
                {
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        @comparacionResult.Mensaje
                    </div>
                }
                else if (comparacionResult.Comparaciones.Any())
                {
                    <!-- Tabla de comparaciones -->
                    @foreach (var comparacion in comparacionResult.Comparaciones)
                    {
                        <div class="card mb-3 border-primary">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <strong>@comparacion.MedicamentoNombre</strong>
                                    <span class="text-muted ms-2">(@comparacion.MedicamentoFabricante - @comparacion.MedicamentoPresentacion)</span>
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="text-align: center;">Proveedor</th>
                                                <th style="text-align: center;">NIT</th>
                                                <th style="text-align: center;">Unidades</th>
                                                <th style="text-align: center;">Total Invertido</th>
                                                <th style="text-align: center;">Precio Promedio</th>
                                                <th style="text-align: center;">Órdenes</th>
                                                <th style="text-align: center;">Mejor Precio</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var prov in comparacion.Proveedores)
                                            {
                                                var esMejorPrecio = prov.ProveedorId == comparacion.MejorPrecioProveedorId;
                                                <tr class="@(esMejorPrecio ? "table-success" : "")">
                                                    <td style="text-align: center;">
                                                        <strong>@prov.ProveedorNombre</strong>
                                                    </td>
                                                    <td style="text-align: center;">@prov.ProveedorNit</td>
                                                    <td style="text-align: center;">@prov.TotalUnidadesCompradas.ToString("N0")</td>
                                                    <td style="text-align: center; ">$@prov.TotalDineroInvertido.ToString("N2")</td>
                                                    <td style="text-align: center;">
                                                        <strong>$@prov.PrecioPromedio.ToString("N2")</strong>
                                                    </td>
                                                    <td style="text-align: center;">
                                                        <span>@prov.NumeroOrdenes</span>
                                                    </td>
                                                    <td style="text-align: center;">
                                                        @if (esMejorPrecio)
                                                        {
                                                            <span class="badge bg-success">
                                                                <i class="bi bi-star-fill"></i> Mejor
                                                            </span>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    }

    <!-- Resultados: Reporte de Compras -->
    @if (mostrarResultados && tipoReporte == "compras" && reporteComprasResult != null)
    {
        <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="bi bi-file-earmark-bar-graph me-2"></i>
                    Reporte Consolidado de Compras
                </h5>
            </div>
            <div class="card-body">
                <!-- Resumen General -->
                <div class="row mb-4">
                    <div class="col-md-2">
                        <div class="alert alert-info mb-0 text-center">
                            <small class="text-muted d-block">Período</small>
                            <strong>@reporteComprasResult.FechaInicio.ToString("dd/MM/yyyy")</strong>
                            <div>a</div>
                            <strong>@reporteComprasResult.FechaFin.ToString("dd/MM/yyyy")</strong>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="alert alert-primary mb-0 text-center">
                            <small class="text-muted d-block">Órdenes</small>
                            <h4 class="mb-0">@reporteComprasResult.TotalOrdenes</h4>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="alert alert-warning mb-0 text-center">
                            <small class="text-muted d-block">Proveedores</small>
                            <h4 class="mb-0">@reporteComprasResult.TotalProveedores</h4>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="alert alert-secondary mb-0 text-center">
                            <small class="text-muted d-block">Medicamentos</small>
                            <h4 class="mb-0">@reporteComprasResult.TotalMedicamentos</h4>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-success mb-0 text-center">
                            <small class="text-muted d-block">Total Invertido</small>
                            <h3 class="mb-0 text-success">$@reporteComprasResult.GranTotalInvertido.ToString("N2")</h3>
                        </div>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(reporteComprasResult.Mensaje))
                {
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        @reporteComprasResult.Mensaje
                    </div>
                }
                else
                {
                    <!-- Tabs para Detalles y Totales -->
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link @(tabActivo == "detalles" ? "active" : "")" 
                                    @onclick='() => tabActivo = "detalles"'>
                                <i class="bi bi-table me-2"></i>
                                Detalle por Medicamento y Proveedor
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link @(tabActivo == "totales" ? "active" : "")" 
                                    @onclick='() => tabActivo = "totales"'>
                                <i class="bi bi-building me-2"></i>
                                Totales por Proveedor
                            </button>
                        </li>
                    </ul>

                    <!-- Tab: Detalles -->
                    @if (tabActivo == "detalles" && reporteComprasResult.Detalles.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="text-align: center;">Medicamento</th>
                                        <th style="text-align: center;">Fabricante</th>
                                        <th style="text-align: center;">Presentación</th>
                                        <th style="text-align: center;">Proveedor</th>
                                        <th style="text-align: center;">Unidades</th>
                                        <th style="text-align: center;">Total Invertido</th>
                                        <th style="text-align: center;">Precio Promedio</th>
                                        <th style="text-align: center;">Órdenes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var detalle in reporteComprasResult.Detalles)
                                    {
                                        <tr>
                                            <td style="text-align: center;"><strong>@detalle.MedicamentoNombre</strong></td>
                                            <td style="text-align: center; text-color: #000">@detalle.MedicamentoFabricante</td>
                                            <td style="text-align: center; text-color: #000">@detalle.MedicamentoPresentacion</td>
                                            <td style="text-align: center; text-color: #000">
                                                @detalle.ProveedorNombre
                                                <small class="text-muted d-block">@detalle.ProveedorNit</small>
                                            </td>
                                            <td style="text-align: center; text-color: #000">@detalle.TotalUnidadesCompradas.ToString("N0")</td>
                                            <td style="text-align: center; text-color: #000"><strong>$@detalle.TotalDineroInvertido.ToString("N2")</strong></td>
                                            <td style="text-align: center; text-color: #000">$@detalle.PrecioPromedio.ToString("N2")</td>
                                            <td style="text-align: center; text-color: #000">
                                                <span>@detalle.NumeroOrdenes</span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }

                    <!-- Tab: Totales por Proveedor -->
                    @if (tabActivo == "totales" && reporteComprasResult.TotalesPorProveedor.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-primary">
                                    <tr>
                                        <th>Proveedor</th>
                                        <th>NIT</th>
                                        <th class="text-center">Órdenes</th>
                                        <th class="text-end">Total Items</th>
                                        <th class="text-end">Total Invertido</th>
                                        <th class="text-center">% del Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var total in reporteComprasResult.TotalesPorProveedor)
                                    {
                                        var porcentaje = reporteComprasResult.GranTotalInvertido > 0 
                                            ? (total.TotalInvertido / reporteComprasResult.GranTotalInvertido * 100) 
                                            : 0;
                                        
                                        <tr>
                                            <td><strong>@total.ProveedorNombre</strong></td>
                                            <td class="text-muted">@total.ProveedorNit</td>
                                            <td class="text-center">
                                                <span class="badge bg-secondary">@total.TotalOrdenes</span>
                                            </td>
                                            <td class="text-end">@total.TotalItems.ToString("N0")</td>
                                            <td class="text-end">
                                                <strong class="text-success">$@total.TotalInvertido.ToString("N2")</strong>
                                            </td>
                                            <td class="text-center">
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar bg-success" 
                                                         style="width: @porcentaje.ToString("F1")%"
                                                         role="progressbar">
                                                        @porcentaje.ToString("F1")%
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot class="table-light">
                                    <tr class="fw-bold">
                                        <td colspan="2">TOTAL GENERAL</td>
                                        <td class="text-center">@reporteComprasResult.TotalOrdenes</td>
                                        <td class="text-end">
                                            @reporteComprasResult.TotalesPorProveedor.Sum(t => t.TotalItems).ToString("N0")
                                        </td>
                                        <td class="text-end text-success">
                                            $@reporteComprasResult.GranTotalInvertido.ToString("N2")
                                        </td>
                                        <td class="text-center">100%</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    }
                }
            </div>
        </div>
    }
</div>

@code {
    private DateTime fechaInicio = DateTime.Today.AddMonths(-6);
    private DateTime fechaFin = DateTime.Today;
    
    private bool cargando = false;
    private bool mostrarResultados = false;
    private string tipoReporte = "";
    private string tabActivo = "detalles";
    
    private string mensajeError = string.Empty;
    private string mensajeValidacion = string.Empty;
    
    private ComparacionPreciosResponse? comparacionResult = null;
    private ReporteComprasResponse? reporteComprasResult = null;

    protected override async Task OnInitializedAsync()
    {
        // Verificar que el usuario es admin
        var role = await AuthService.GetUserRoleAsync();
        if (role != "admin")
        {
            NavigationManager.NavigateTo("/");
            return;
        }
    }

    private bool ValidarFechas()
    {
        mensajeValidacion = string.Empty;
        
        if (fechaFin < fechaInicio)
        {
            mensajeValidacion = "La fecha de fin debe ser mayor o igual a la fecha de inicio.";
            return false;
        }
        
        var diasDiferencia = (fechaFin - fechaInicio).Days;
        if (diasDiferencia > 365)
        {
            mensajeValidacion = "El rango máximo permitido es de 12 meses (365 días).";
            return false;
        }
        
        if (fechaFin > DateTime.Today)
        {
            mensajeValidacion = "La fecha de fin no puede ser mayor a la fecha actual.";
            return false;
        }
        
        return true;
    }

    private async Task GenerarComparacionPrecios()
    {
        if (!ValidarFechas()) return;
        
        cargando = true;
        tipoReporte = "comparacion";
        mostrarResultados = false;
        mensajeError = string.Empty;
        
        try
        {
            var filtros = new FiltrosReporteRequest
            {
                FechaInicio = DateOnly.FromDateTime(fechaInicio),
                FechaFin = DateOnly.FromDateTime(fechaFin)
            };
            
            comparacionResult = await ReporteService.ComparacionPreciosAsync(filtros);
            mostrarResultados = true;
        }
        catch (HttpRequestException ex)
        {
            mensajeError = ex.Message;
        }
        catch (Exception ex)
        {
            mensajeError = $"Error inesperado: {ex.Message}";
        }
        finally
        {
            cargando = false;
        }
    }

    private async Task GenerarReporteCompras()
    {
        if (!ValidarFechas()) return;
        
        cargando = true;
        tipoReporte = "compras";
        mostrarResultados = false;
        mensajeError = string.Empty;
        tabActivo = "detalles";
        
        try
        {
            var filtros = new FiltrosReporteRequest
            {
                FechaInicio = DateOnly.FromDateTime(fechaInicio),
                FechaFin = DateOnly.FromDateTime(fechaFin)
            };
            
            reporteComprasResult = await ReporteService.ReporteComprasAsync(filtros);
            mostrarResultados = true;
        }
        catch (HttpRequestException ex)
        {
            mensajeError = ex.Message;
        }
        catch (Exception ex)
        {
            mensajeError = $"Error inesperado: {ex.Message}";
        }
        finally
        {
            cargando = false;
        }
    }

    private void LimpiarResultados()
    {
        mostrarResultados = false;
        comparacionResult = null;
        reporteComprasResult = null;
        mensajeError = string.Empty;
        mensajeValidacion = string.Empty;
        tipoReporte = "";
    }
}
